---
title: "Datos historicos de flota de taxis en Madrid"
author: "Alejandro Vaqueiro, Ester Sánchez, Inês Bolaños, Silvia Lendínez"
date : 15 febrero 2019
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: united
    highlight: tango

---

Debido a la falta de datos, queremos resaltar que para este trabajo no vamos a utilizar el tema de nuestro TFM.

Hemos utilizado una base de datos sobre la flota de taxis dentro de la ciudad de Madrid. Vamos a usar información como las marcas, el combustible y la cilindrada y potencia de los vehiculos para realizar un análisis exploratorio, teniendo en cuenta las limitaciones del tipo de variables a la hora de hacer gráficos.

El objetivo de nuestro trabajo es aprender a limpiar una base de datos, transformar, visualizar e interpretar las principales variables.

Para ello, en primer lugar, hemos importado el archivo *TaxiFlota.csv.* Luego, hemos realizado la limpieza de datos (cambio de variables, cambiar el nombre de las columnas, eliminar columnas, formato fecha, etc.)

Por último hemos hecho algunas representaciones gráficas con las variables más relevantes.


# 1. Obtención de los datos

Importación de la base de datos *Taxi Flota* de la base de datos abiertos de Madrid, en formato .csv


```{r}
datos <- read.table("TaxiFlota.csv", sep = ";", header = TRUE, stringsAsFactors = FALSE )
```

Vemos la dimensión
```{r}
dim(datos)
```
Mostramos la info de las 5 primeras filas
```{r}
head(datos,5)
```

Mostramos los últimos datos
```{r}
tail(datos)
```

# 2. Tratamiento y limpieza

Hemos cambiado el nombre de las columnas para que sean representativos y usables, cambiado el tipo de variables según les corresponda y eliminado variables que no tenían información relevante para nuestro análisis.

## 1. Renombrar los nombres de las columnas
  
### 1.1 Cambiar los títulos a minúsculas
```{r}
colnames(datos) <- sapply(colnames(datos), tolower) 
colnames(datos)
```

### 1.2 Sustituir los espacios por "_"
```{r}
colnames(datos) <- gsub("\\.", "_", colnames(datos)) 
colnames(datos)
```

### 1.3 Quitar tildes
```{r}
colnames(datos) <- iconv(colnames(datos), to='ASCII//TRANSLIT')
colnames(datos)
```

### 1.4. Renombrar manualmente las columnas con nombres más largos
```{r}
colnames(datos)[12] <- "numero_plazas"
colnames(datos)[13] <- "fecha_inicio_prestacion"
colnames(datos)[15] <- "regimen_eurotaxi"
colnames(datos)[16] <- "fecha_inicio_eurotaxi"
colnames(datos)[17] <- "fecha_fin_eurotaxi"

colnames(datos)
```

## 2. Convertir las variables a los tipos correspondientes

### 2.1 Inspeccionar el tipo de variables
```{r}
sapply(datos, class)
```

### 2.2 Identificar las variables a cambiar:

- **codigo**: int -> character
- **matricula**: OK
- **fecha_matriculacion**: character -> date
- **marca**: OK
- **modelo**: OK
- **tipo**: borrar, aporta poca información
- **variante**: borrar, aporta poca información
- **clasificacion_medioambiental**: character -> category
- **combustible**: OK
- **cilindrada**: OK
- **potencia**: OK
- **numero_plazas**: OK
- **fecha_inicio**: character -> date
- **eurotaxi**: OK, cambiar *'si'* y *'no'* por *'0'* y *'1'*
- **regimen_eurotaxi**: OK, cambiar *'si'* y *'no'* por *'0'* y *'1'*
- **fecha_inicio_eurotaxi**: borrar, aporta poca información
- **fecha_fin_eurotaxi**: borrar, aporta poca información
- **fecha**: borrar, aporta poca información


codigo: int -> character
```{r}
datos$codigo <- as.character(datos$codigo)
```

fecha_matriculacion: character -> date
```{r}
datos$fecha_matriculacion <- strptime(datos$fecha_matriculacion, "%d/%m/%Y") 
datos$fecha_matriculacion <- as.POSIXct(datos$fecha_matriculacion, tz= "", format="%d/%m/%Y") 
```
clasificacion_medioambiental: character -> category
```{r}
datos$clasificacion_medioambiental <- as.ordered(datos$clasificacion_medioambiental)
```
fecha inicio: character -> date
```{r}
datos$fecha_inicio_prestacion <- strptime(datos$fecha_inicio_prestacion, "%d/%m/%Y") 
datos$fecha_inicio_prestacion <- as.POSIXct(datos$fecha_inicio_prestacion, tz= "", format="%d/%m/%Y") 
```
eurotaxi y regimen_eurotaxi: cambiar 'si' y 'no' a '0' y '1'
```{r}
datos$eurotaxi[datos$eurotaxi == "SI"] <- 1
datos$eurotaxi[datos$eurotaxi == "NO"] <- 0

datos$regimen_eurotaxi[datos$regimen_eurotaxi == "SI"] <- 1
datos$regimen_eurotaxi[datos$regimen_eurotaxi == "NO"] <- 0
```
Eliminamos columnas que consideramos innecesarias para nuestro trabajo
```{r}
datos$Tipo <- NULL
datos$Variante <- NULL
datos$Fecha <- NULL
datos$Fecha.inicio.Regimen.Especial.Eurotaxi <- NULL
datos$Fecha.fin.Regimen.Especial.Eurotaxi <- NULL
```

Comprobamos los tipos de las columnas
```{r}
sapply(datos, class)
```

# 3. Enriquecimiento de datos

Los datos abiertos de Madrid no tienen otras bases de datos de taxis que tengan índices que se puedan cruzar con la base de datos que estamos analizando. 

No hemos encontrado bases de datos abiertas de vehículos de transporte colectivo para poder hacer una comparación con la base de datos de taxis.

De estar forma, hemos trabajado solo sobre la base de datos de taxis que hemos importado, sin cruzar o comparar con una segunda base de datos.

# 4. Análisis exploratorio

Hemos analizado la distribución de algunas variables de nuestra bases de datos y algunas correlaciones entre variables.

## Evolución de los taxis matriculados cada año
```{r}
hist(datos$fecha_matriculacion, 
     breaks = "years", 
     format = "%Y", 
     freq = TRUE,
     las = 2,
     col = "lightskyblue2",
     xlab = "Fecha de matriculación",
     ylab = "Num vehiculos",
     main = "Taxis matriculados por año")
```

## Evolución del inicio de la actividad de taxis por año
```{r}
hist(datos$fecha_inicio_prestacion, 
     breaks = "years", 
     format = "%Y", 
     freq = TRUE,
     las = 2,
     col = "seagreen3",
     xlab = "Fecha de inicio de servicio",
     ylab = "Num vehiculos",
     main = " Inicio actividad taxis por año")
```

Podemos observar que no hay mucha variación entre el histograma anterior y este.
Es decir, lo lógico es que los taxis sean matriculados e inicien su servicio en el mismo año.

Para comprobarlo, vemos la relación entre la fecha de matriculación y la fecha de inicio de la actividad de taxis.
Observamos que hay una relación directa entre ambas, con algunos casos cuya fecha de inicio de actividad es superior a la fecha de matriculación

```{r}
library (ggplot2)
qplot(datos$fecha_matriculacion, datos$fecha_inicio_prestacion,
      xlab = "Fecha de matriculación",
      ylab = "Fecha de inicio de la actividad",
      col = "red",
      main = "Relación entre fecha de matriculación e inicio de la actividad"
)
```

## Relación entre potencia y cilindrada según clasificación medioambiental
Para evitar problemas con datos en blancos, los sustituimos por "0"

```{r}
datos$potencia[is.na(datos$potencia)] <- 0
```

Se ve una relación directa entre potencia y cilindrada y según estas variables tengan valores más bajos, el nivel de contaminación es menor. 

No se puede asumir una relación directa entre los coches con nivel de contaminación 0, una vez que el número de casos que asume este valor es muy reducido y no se pueden sacar conclusiones.

```{r}
ggplot(datos, aes(x = cilindrada, y =potencia, colour = clasificacion_medioambiental)) + geom_point(aes(size = clasificacion_medioambiental))
```